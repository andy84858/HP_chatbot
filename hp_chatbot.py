import streamlit as st
import os
import langid
from langchain.prompts import ChatPromptTemplate
from langchain_openai import ChatOpenAI

# è¨­ç½® OpenAI API å¯†é‘°
os.environ['OPENAI_API_KEY'] = 'sk-proj-49ufsRDjIcgDPUvDmKpJT3BlbkFJ2Cc6iuar03CLdlKWGE6A'

# å‰µå»ºèŠå¤©æ¨¡å‹
chat_model = ChatOpenAI(model_name="gpt-4o-mini")

def detect_language(text):
    lang, _ = langid.classify(text)
    return 'zh' if lang == 'zh' else 'en'

def generate_response(query, language, chat_history):
    # å°‡èŠå¤©æ­·å²è½‰æ›ç‚ºå­—ç¬¦ä¸²æ ¼å¼
    history_str = "\n".join([f"Human: {msg['content']}" if msg['role'] == 'user' else f"AI: {msg['content']}" for msg in chat_history])

    if language == 'zh':
        prompt_template = ChatPromptTemplate.from_template(
            "ä½ æ˜¯ä¸€å€‹å°ˆé–€å›ç­”é—œæ–¼å“ˆåˆ©æ³¢ç‰¹å•é¡Œçš„AIåŠ©æ‰‹ã€‚è«‹è€ƒæ…®ä»¥ä¸‹å°è©±æ­·å²ï¼Œä¸¦ä»¥ç¹é«”ä¸­æ–‡ç‰ˆå°èªªçš„ç¿»è­¯åç¨±å›ç­”æœ€æ–°çš„å•é¡Œï¼š\n\n"
            "å°è©±æ­·å²ï¼š\n{history}\n\n"
            "Human: {query}\n"
            "AI: "
        )
    else:
        prompt_template = ChatPromptTemplate.from_template(
            "You are an AI assistant specializing in answering questions about Harry Potter. "
            "Please consider the following conversation history and answer the latest question in English:\n\n"
            "Conversation history:\n{history}\n\n"
            "Human: {query}\n"
            "AI: "
        )

    prompt = prompt_template.format(history=history_str, query=query)
    response = chat_model.invoke(prompt)

    return response.content

def main():
    st.title("âš¡ğŸ§¹Harry Potter Chatbot âš¡ğŸ§¹")

    # åˆå§‹åŒ–èŠå¤©æ­·å²
    if 'messages' not in st.session_state:
        st.session_state.messages = []

    # é¡¯ç¤ºèŠå¤©æ­·å²
    for message in st.session_state.messages:
        with st.chat_message(message["role"]):
            st.markdown(message["content"])

    # æ¥å—ç”¨æˆ¶è¼¸å…¥
    if prompt := st.chat_input("What would you like to know about Harry Potter?"):
        st.session_state.messages.append({"role": "user", "content": prompt})
        with st.chat_message("user"):
            st.markdown(prompt)

        # æª¢æ¸¬èªè¨€ä¸¦ç”Ÿæˆå›æ‡‰
        language = detect_language(prompt)
        response = generate_response(prompt, language, st.session_state.messages)

        # é¡¯ç¤ºåŠ©æ‰‹å›æ‡‰
        with st.chat_message("assistant"):
            st.markdown(response)
        st.session_state.messages.append({"role": "assistant", "content": response})

    # æ·»åŠ å´é‚Šæ¬„èªªæ˜
    st.sidebar.title("About")
    st.sidebar.info(
        "This chatbot can answer questions about Harry Potter novels in both English and Traditional Chinese. "
        "Simply type your question in either language, and the bot will respond accordingly."
    )
    st.sidebar.info(
        "é€™å€‹èŠå¤©æ©Ÿå™¨äººå¯ä»¥ç”¨ç¹é«”ä¸­æ–‡å’Œè‹±æ–‡å›ç­”é—œæ–¼å“ˆåˆ©æ³¢ç‰¹çš„å•é¡Œã€‚"
        "åªéœ€ç”¨ä»»ä½•ä¸€ç¨®èªè¨€è¼¸å…¥æ‚¨çš„å•é¡Œï¼Œæ©Ÿå™¨äººå°±æœƒç›¸æ‡‰åœ°å›ç­”ã€‚"
    )
    
    # æ·»åŠ å…è²¬è²æ˜
    st.sidebar.warning(
        "Disclaimer: The answers generated by this model might contain errors. Please evaluate the responses with caution."
    )
    st.sidebar.warning(
        "å…è²¬è²æ˜ï¼šæ¨¡å‹ç”Ÿæˆçš„å›ç­”å¯èƒ½æœ‰èª¤ï¼Œè«‹è¬¹æ…è©•ä¼°å›è¦†å…§å®¹ã€‚"
    )

if __name__ == "__main__":
    main()
